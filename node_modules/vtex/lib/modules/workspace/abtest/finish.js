"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const chalk_1 = __importDefault(require("chalk"));
const enquirer_1 = __importDefault(require("enquirer"));
const ramda_1 = require("ramda");
const conf_1 = require("../../../conf");
const errors_1 = require("../../../errors");
const logger_1 = __importDefault(require("../../../logger"));
const prompts_1 = require("../../prompts");
const status_1 = __importDefault(require("./status"));
const utils_1 = require("./utils");
const [account] = [conf_1.getAccount()];
const promptContinue = async (workspace) => {
    const proceed = await prompts_1.promptConfirm(`You are about to finish A/B testing in workspace \
${chalk_1.default.blue(workspace)}, account ${chalk_1.default.green(account)}. Are you sure?`, false);
    if (!proceed) {
        throw new errors_1.UserCancelledError();
    }
};
const promptWorkspaceToFinishABTest = async () => await utils_1.abtester
    .status()
    .then(ramda_1.map(({ WorkspaceB }) => WorkspaceB))
    .then((workspaces) => enquirer_1.default.prompt({
    name: 'workspace',
    message: 'Choose which workspace to finish A/B testing:',
    type: 'select',
    choices: workspaces,
}))
    .then(ramda_1.prop('workspace'));
exports.default = async () => {
    await utils_1.installedABTester();
    const workspace = await promptWorkspaceToFinishABTest();
    await promptContinue(workspace);
    logger_1.default.info('Finishing A/B tests');
    logger_1.default.info(`Latest results:`);
    await status_1.default();
    await utils_1.abtester.finish(workspace);
    logger_1.default.info(`A/B testing with workspace ${chalk_1.default.blue(workspace)} is now finished`);
    logger_1.default.info(`No traffic currently directed to ${chalk_1.default.blue(workspace)}`);
};
