"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const clients_1 = require("../../clients");
const manifest_1 = require("../../lib/manifest");
const logger_1 = __importDefault(require("../../logger"));
const utils_1 = require("./utils");
const { unlink, unlinkAll, listLinks } = clients_1.apps;
const unlinkApp = async (app) => {
    var _a, _b, _c;
    manifest_1.ManifestValidator.validateApp(app);
    try {
        logger_1.default.info('Starting to unlink app:', app);
        await unlink(app);
        logger_1.default.info('Successfully unlinked', app);
    }
    catch (e) {
        if (e.response.status === 404) {
            logger_1.default.error(`${app} is not linked in the current workspace. \
Make sure you typed the right app vendor, name and version.`);
        }
        else {
            logger_1.default.error(`Error unlinking ${app}.`, e.message);
            if ((_c = (_b = (_a = e) === null || _a === void 0 ? void 0 : _a.response) === null || _b === void 0 ? void 0 : _b.data) === null || _c === void 0 ? void 0 : _c.message) {
                logger_1.default.error(e.response.data.message);
            }
        }
    }
};
const unlinkApps = async (appsList) => {
    await utils_1.validateAppAction('unlink', appsList);
    await Promise.all(appsList.map(unlinkApp));
};
const unlinkAllApps = async () => {
    var _a, _b, _c;
    try {
        logger_1.default.info('Starting to unlink all apps');
        await unlinkAll();
        logger_1.default.info('Successfully unlinked all apps');
    }
    catch (e) {
        logger_1.default.error('Error unlinking all apps.', e.message);
        if ((_c = (_b = (_a = e) === null || _a === void 0 ? void 0 : _a.response) === null || _b === void 0 ? void 0 : _b.data) === null || _c === void 0 ? void 0 : _c.message) {
            logger_1.default.error(e.response.data.message);
        }
    }
};
exports.default = async (optionalApp, options) => {
    const linkedApps = await listLinks();
    if (linkedApps.length === 0) {
        return logger_1.default.info('No linked apps?');
    }
    if (options.a || options.all) {
        return unlinkAllApps();
    }
    const app = optionalApp || (await manifest_1.ManifestEditor.getManifestEditor()).appLocator;
    const appsList = [app, ...utils_1.parseArgs(options._)];
    return unlinkApps(appsList);
};
